<div>
  <h2 id="page-heading" data-cy="SummarizePlanHeading">
    <span>Báo cáo đánh giá chi tiết BBKT</span>
  </h2>
  <div class="col-container">
    <div class="col-container">
      <div class="col col-container-child mx-2">
        <label for="field_timeStart">Thời gian bắt đầu</label>
        <p-calendar appendTo="body" [(ngModel)]="reportDto.timeStart" dateFormat="dd/mm/yy" [showTime]="false" [hourFormat]="'24'" />
      </div>
      <div class="col col-container-child mx-2">
        <label for="field_timeEnd">Thời gian kết thúc</label>
        <p-calendar appendTo="body" [(ngModel)]="reportDto.timeEnd" dateFormat="dd/mm/yy" [showTime]="false" [hourFormat]="'24'" />
      </div>
      <div class="col col-container-child mx-2">
        <label for="field_selectedBranches">Bộ phận được kiểm tra</label>
        <p-multiSelect
          [maxSelectedLabels]="1"
          [options]="listBranch"
          optionLabel="name"
          optionValue="name"
          placeholder="Không đánh giá"
          [(ngModel)]="reportDto.subjectOfAssetmentPlan"
          [showClear]="true"
          id="field_selectedBranches"
          display="chip"
          [appendTo]="'body'"
          styleClass="w-full"
          (onChange)="filterTeamsByBranch()"
        />
      </div>
      <div class="col col-container-child mx-2">
        <label for="field_selectedTeams">Tổ được kiểm tra</label>
        <p-multiSelect
          [maxSelectedLabels]="1"
          [options]="listTeams"
          optionLabel="name"
          optionValue="name"
          placeholder="Không đánh giá"
          [(ngModel)]="reportDto.groupName"
          [showClear]="true"
          id="field_selectedTeams"
          display="chip"
          [appendTo]="'body'"
          styleClass="w-full"
        />
      </div>
      <div class="col col-container-child mx-2">
        <label for="field_TestOfObject">Người được kiểm tra</label>
        <p-multiSelect
          [maxSelectedLabels]="1"
          [options]="listTestOfObject"
          optionLabel="name"
          optionValue="name"
          placeholder="Không đánh giá"
          [(ngModel)]="reportDto.testOfObject"
          [showClear]="true"
          id="field_TestOfObject"
          display="chip"
          [appendTo]="'body'"
          styleClass="w-full"
        />
      </div>
      <div class="col col-container-child mx-2">
        <label for="field_selectedReportType">Loại BBKT</label>
        <p-multiSelect
          [maxSelectedLabels]="1"
          [options]="listReportType"
          optionLabel="name"
          optionValue="name"
          placeholder="Không đánh giá"
          [(ngModel)]="reportDto.reportType"
          [showClear]="true"
          id="field_selectedReportType"
          display="chip"
          [appendTo]="'body'"
          styleClass="w-full"
        />
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end">
    <button pButton type="button" label="Tìm kiếm" icon="pi pi-search" class="p-button-infor" (click)="loadData()"></button>
    <button pButton type="button" label="Xuất Excel" icon="pi pi-file-excel" class="p-button-success" (click)="exportExcel()"></button>
  </div>

  <div class="table-reposive">
    <p-table
      [value]="data"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [lazy]="true"
      [loading]="loading"
      (onLazyLoad)="onPage($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục"
      [tableStyle]="{ 'min-width': '50rem' }"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="timeStart">Thời gian kế hoạch KT<p-sortIcon field="timeStart"></p-sortIcon></th>
          <th pSortableColumn="planName">Tên kế hoạch KT<p-sortIcon field="planName"></p-sortIcon></th>
          <th pSortableColumn="reportName">Tên BBKT<p-sortIcon field="reportName"></p-sortIcon></th>
          <th pSortableColumn="checker">Người kiểm tra<p-sortIcon field="checker"></p-sortIcon></th>
          <th pSortableColumn="subjectOfAssetmentPlan">Ngành <p-sortIcon field="subjectOfAssetmentPlan"></p-sortIcon></th>
          <th pSortableColumn="groupName">Tên tổ <p-sortIcon field="groupName"></p-sortIcon></th>
          <th pSortableColumn="testOfObject">Người được kiểm tra <p-sortIcon field="testOfObject"></p-sortIcon></th>
          <th pSortableColumn="reportType">Loại BB Kiểm tra <p-sortIcon field="reportType"></p-sortIcon></th>
          <th pSortableColumn="sumOfAudit">Tổng số đợt kiểm tra <p-sortIcon field="sumOfAudit"></p-sortIcon></th>
          <th pSortableColumn="sumOfCreateReport">Tổng số lần lập biên bản <p-sortIcon field="sumOfCreateReport"></p-sortIcon></th>
          <th>Tổng điểm</th>
          <th>Điểm trung bình</th>
          <th pSortableColumn="sumOfNc">Tổng NC <p-sortIcon field="sumOfNc"></p-sortIcon></th>
          <th pSortableColumn="sumOfLy">Tổng LY <p-sortIcon field="sumOfLy"></p-sortIcon></th>
          <th pSortableColumn="sumOfLy">Tổng PASS <p-sortIcon field="sumOfLy"></p-sortIcon></th>
          <th pSortableColumn="sumOfPass">Tổng đạt <p-sortIcon field="sumOfPass"></p-sortIcon></th>
          <th pSortableColumn="sumOfFail">Tổng không đạt <p-sortIcon field="sumOfFail"></p-sortIcon></th>
          <th pSortableColumn="sumOfUncheck">Tổng số lỗi chưa khắc phục <p-sortIcon field="sumOfUncheck"></p-sortIcon></th>
          <th pSortableColumn="status">Chi tiết</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-row>
        <tr>
          <td>{{ row.timeStart | date: 'dd/MM/yyyy' }}</td>
          <td>{{ row.planName }}</td>
          <td>{{ row.reportName }}</td>
          <td>{{ row.checker }}</td>
          <td>{{ row.subjectOfAssetmentPlan }}</td>
          <td>{{ row.groupName }}</td>
          <td>{{ row.testOfObject }}</td>
          <td>{{ row.reportType }}</td>
          <td>{{ row.sumOfAudit }}</td>
          <td>{{ row.sumOfCreateReport }}</td>
          <td>{{ getTotalPoint(row) }}</td>
          <td>{{ getTotalPointAvg(row) | noZeroDecimal }}</td>
          <td>{{ row.sumOfNc }}</td>
          <td>{{ row.sumOfLy }}</td>
          <td>{{ row.convertScore == 'Tính điểm' ? row.sumOfPass : 0 }}</td>
          <td>{{ row.convertScore == 'Bước nhảy' ? row.sumOfPass : 0 }}</td>
          <td>{{ row.sumOfFail }}</td>
          <td>{{ row.sumOfUncheck }}</td>
          <td>
            <button
              pButton
              pRipple
              type="button"
              icon="pi pi-eye"
              class="p-button-rounded p-button-success mr-2"
              (click)="showDialogGeneralCheckPlan(row)"
            ></button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="empty">
        <tr>
          <td colspan="19">No records found</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- view detail -->

<p-dialog
  header="Tổng hợp biên bản kiểm tra"
  [resizable]="false"
  [modal]="true"
  [maximizable]="true"
  appendTo="body"
  [(visible)]="dialogGeneralCheckPlan"
  [style]="{ width: '80vw' }"
  [contentStyle]="{ height: '70vh' }"
>
  <div class="col-container">
    <div class="col-m4-25 col-container-child">
      <label for="">Mã BBKT</label>
      <input type="text" class="inp-style" [(ngModel)]="reportSelected.reportCode" readonly />
    </div>

    <div class="col-m4-25 col-container-child">
      <label for="">Tên BBKT</label>
      <input type="text" class="inp-style" [(ngModel)]="reportSelected.reportName" readonly />
    </div>

    <div class="col-m4-25 col-container-child">
      <label for="">Đối tượng kế hoạch đánh giá</label>
      <input type="text" class="inp-style" [(ngModel)]="reportSelected.testOfObject" readonly />
    </div>

    <div class="col-m4-25 col-container-child">
      <label for="">Kiểu quy đổi</label>
      <input type="text" class="inp-style" [(ngModel)]="reportSelected.convertScore" readonly />
    </div>
  </div>
  <p-table
    [value]="checkPlanDetails"
    [paginator]="true"
    [rows]="100"
    [responsive]="true"
    styleClass="p-datatable-gridlines"
    [rowsPerPageOptions]="[5, 10, 20]"
    [autoLayout]="true"
  >
    <ng-template pTemplate="header">
      <tr>
        <th class="text-center border">STT</th>
        <th class="text-center border">Điểm theo đợt kiểm tra</th>
        <th class="text-center border">Mã kế hoạch</th>
        <th class="text-center border">Tên kế hoạch</th>
        <th class="text-center border">Ngày kiểm tra</th>
        <ng-container *ngIf="reportSelected.convertScore == 'Tính điểm'; else buocNhayTH">
          <th class="text-center border">NC</th>
          <th class="text-center border">LY</th>
        </ng-container>
        <ng-template #buocNhayTH>
          <th class="text-center border">Không đạt</th>
        </ng-template>
        <th class="text-center border">Tuỳ chọn</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-reportSum let-index="rowIndex">
      <tr>
        <td class="text-center border">{{ index + 1 }}</td>
        <td class="text-center border">{{ totalPointSummarize(reportSum) }}</td>
        <td class="text-center border">{{ reportSum.planGroupHistoryCode }}</td>
        <td class="text-center border">{{ reportSum.planGroupHistoryName }}</td>
        <td class="text-center border">{{ reportSum.checkDate }}</td>
        <ng-container *ngIf="reportSelected.convertScore == 'Tính điểm'; else buocNhay">
          <td class="text-center border">{{ reportSum.sumOfNc }}</td>
          <td class="text-center border">{{ reportSum.sumOfLy }}</td>
        </ng-container>
        <ng-template #buocNhay>
          <td class="text-center border">{{ reportSum.sumOfFail }}</td>
        </ng-template>
        <td class="text-center border">
          <div class="action-buttons">
            <p-button
              icon="pi pi-reply"
              aria-label="check"
              styleClass="p-button-rounded p-button-info p-button-sm mr-2"
              [severity]="'info'"
              title="Chi tiết"
              (onClick)="showDialogSummaryOfCriteriaConclusion(reportSum)"
            />
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog
  header="Tổng hợp kết luận tiêu chí"
  [resizable]="false"
  [modal]="true"
  [maximizable]="true"
  appendTo="body"
  [(visible)]="dialogSummaryOfCriteriaConclusion"
  [style]="{ width: '80vw' }"
  [contentStyle]="{ height: '70vh' }"
>
  <p-table [value]="criteriaSummaries">
    <ng-template
      pTemplate="header"
      [paginator]="true"
      [rows]="100"
      [responsive]="true"
      styleClass="p-datatable-gridlines"
      [rowsPerPageOptions]="[5, 10, 20]"
      [autoLayout]="true"
    >
      <tr>
        <th class="text-center border">STT</th>
        <th class="text-center border">Nhóm tiêu chí</th>
        <th class="text-center border">Tên tiêu chí</th>
        <th class="text-center border">Kết luận</th>
        <th class="text-center border">Nội dung đánh giá</th>
        <th class="text-center border">Hình ảnh đánh giá</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-criteria let-index="rowIndex">
      <tr>
        <td class="text-center border">{{ index + 1 }}</td>
        <td class="text-start border">{{ criteria.criterialGroupName }}</td>
        <td class="text-start border">{{ criteria.criterialName }}</td>
        <td class="text-center border">{{ criteria.result }}</td>
        <td class="text-center border">{{ criteria.note }}</td>
        <td class="text-center border">
          <p-button (onClick)="showDialogViewImg(criteria.image)" label="Xem ảnh" />
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog header="Xem ảnh báo cáo" [(visible)]="dialogViewImage" [modal]="true" [style]="{ width: '70vw' }" [baseZIndex]="1100">
  <ng-container *ngIf="listImgReports && listImgReports.length > 0; else notImg">
    <ng-container *ngFor="let file of listImgReports">
      <img *ngIf="isImage(file)" [src]="'content/images/bbkt/' + file" class="img-fluid mb-3" alt="Report Image" />
      <video *ngIf="isVideo(file)" [src]="'content/videos/bbkt/' + file" controls class="video-fluid mb-3"></video>
    </ng-container>
  </ng-container>
  <ng-template #notImg>
    <h1>Chưa có ảnh đánh giá</h1>
  </ng-template>
</p-dialog>
